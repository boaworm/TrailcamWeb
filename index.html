<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="wildlife.css">
</head>
<header><title>Trailcam visualization</title></header>
<body>
</body>

<table>
    <tr>
	<td><div id="obsPerYear"></div></td>
	<td><div class="divTableCell" id="obsPerMonth"></div></td>
	<td><div class="divTableCell" id="obsPerHour"></div></td>
    </tr>
    <tr>
	<td><div id="obsPerYearStackedCamera"></div></td>
	<td><div id="obsPerMonthStackedCamera"></div></td>
	<td><div id="obsPerHourStackedCamera"></div></td>
    </tr>
	<td><div id="obsPerHourJanuary"></div></td>
	<td><div id="obsPerHourFebruary"></div></td>
	<td><div id="obsPerHourMarch"></div></td>
    </tr>
    <tr>
	<td><div id="obsPerHourApril"></div></td>
	<td><div id="obsPerHourMay"></div></td>
	<td><div id="obsPerHourJune"></div></td>
    </tr>
    <tr>
	<td><div id="obsPerHourJuly"></div></td>
	<td><div id="obsPerHourAugust"></div></td>
	<td><div id="obsPerHourSeptember"></div></td>
    </tr>
    <tr>
	<td><div id="obsPerHourOctober"></div></td>
	<td><div id="obsPerHourNovember"></div></td>
	<td><div id="obsPerHourDecember"></div></td>
    </tr>
    <tr>
	<td colspan="3"><div id="dayByDayObs"></div> </td>
    </tr>
    <tr>
	<td colspan="3"><div id="dayByDayDeerObs"></div> </td>
    </tr>
    <tr>
	<td><a href="camera.html?name=TOP"><div class="graphLink" id="obsPerHourTopCamera"></div></a></td>
	<td><a href="camera.html?name=MIDDLE"><div class="graphLink" id="obsPerHourMiddleCamera"></div></a></td>
	<td><a href="camera.html?name=HOUSE"><div class="graphLink" id="obsPerHourHouseCamera"></div></a></td>
    </tr>

    <tr>
	<td><a href="camera.html?name=TOP"><div class="graphLink" id="deerObsPerHourTopCamera"></div></td>
	<td><a href="camera.html?name=MIDDLE"><div class="graphLink" id="deerObsPerHourMiddleCamera"></div></a></td>
	<td><a href="camera.html?name=HOUSE"><div class="graphLink" id="deerObsPerHourHouseCamera"></div></a></td>
    </tr>
</table>

<div id="container"></div>
<script src="d3.v7.js"></script>
<script src="shared.js"></script>
<script src="oklahoma_observations.js"></script>
<script src="deer_observations.json.js"></script>
<script>

///////// BEGIN MAIN DATA PROCESSING ////////////
// Extract what years the code is active:

const yearArray = DATA.reduce(function (a, d) {
    if (a.indexOf(d.year) === -1) {
     a.push(d.year);
   }
    return a;
}, []);
yearArray.sort();

// GLOBALS

const yearObsObject = [];
const monthObsObject = [];
const hourObsObject = [];

const obsPerYearStackedCameraObject = [];
const obsPerMonthStackedCameraObject = [];
const obsPerHourStackedCameraObject = [];

const monthlyHourObsObject = [];
const dayByDayObsObject = [];
const dayByDayDeerObsObject = [];
const obsPerHourTopCameraObject = [];
const obsPerHourMiddleCameraObject = [];
const obsPerHourHouseCameraObject = [];

const deerObsPerHourTopCameraObject = [];
const deerObsPerHourMiddleCameraObject = [];
const deerObsPerHourHouseCameraObject = [];

// First and last day in the dataset
let oldestDate = new Date();
let newestDate = new Date();
DATA.forEach((image) => {
    const tmpDate = new Date(image.year, (image.month-1), image.day);
    if(tmpDate < oldestDate){
	oldestDate = new Date(tmpDate);
    }
    if(tmpDate > newestDate){
	newestDate = new Date(tmpDate);
    }
});

// Total obs per year
for( let i = 0; i < yearArray.length; i++ ) {
    const thisYear = DATA.filter(function(d){
		return yearArray[i] === d.year;
    });
    const totalCount = thisYear.reduce(function (a, d) {
		return a = a + +d.count;
    }, 0);

    const obsObject = {
		year: yearArray[i],
		observations: totalCount
    };
    yearObsObject.push( obsObject );
}


// Total obs per year - stacked by camera : obsPerYearStackedCameraObject
yearArray.forEach( (year) => {
	const thisYear = DATA.filter(function(d){
		return year === d.year;
	});
	cameraArray.forEach( (camera) => {
		// Count number of images on that camera
		const animalCount = thisYear.reduce(function (a, d) {
			if(d.camera === camera){
				return a + +d.count;
			}else{
				return a;
			}
		},0);
		let obj = {};
		obj['year'] = year;
		obj['camera'] = camera;
		obj['observations'] = animalCount;
		obsPerYearStackedCameraObject.push( obj );
	});
});

// total obs per month - stacked by camera : obsPerMonthStackedCameraObject
for(var month=1;month<=12;month++){
	const thisMonth = DATA.filter(function(d){
		return month == d.month; // Deliberate == to match 3 and 03
	});
	cameraArray.forEach( (camera) => {
		// Count number of images on that camera
		const animalCount = thisMonth.reduce(function (a, d) {
			if(d.camera == camera){
				return a + +d.count;
			}else{
				return a;
			}
		},0);
		let obj = {};
		obj['month'] = month;
		obj['camera'] = camera;
		obj['observations'] = animalCount;
		//console.log("pushing object : ", obj);
		obsPerMonthStackedCameraObject.push( obj );
	});
}

// Observations by month (irrespective of year)
for( let i = 1; i <= 12; i++ ) {
	const thisMonth = DATA.filter(function(d){
		return i == d.month; // deliberate match of 1 == 01 etc
	});
	//console.log("Processing month " + i + ", found " + thisMonth.length  + " images");

	const totalObsCount = thisMonth.reduce(function(a, d){
		return a = a + +d.count;
	}, 0);
	//console.log("Processing month " + i + ", found " + totalObsCount + " animals");
	const obsObject = {
		month: numericToTextMonth(i),
		observations: totalObsCount
	};
	monthObsObject.push( obsObject );
}

// Observations by hour (irrespective of month, year)
for(let i = 0; i<= 23; i++){
	const thisHour = DATA.filter(function(d){
		return i == d.hour; // delibreate match of 4 == 04 etc
	});
	const totalObsCount = thisHour.reduce(function(a, d){
		return a = a + +d.count;
	}, 0);
	const obsObject = {
		hour: i,
		observations: totalObsCount
	};
	hourObsObject.push( obsObject );
}

// Observations by hour - stacked by camera
for(let hour=0;hour<=23;hour++){
	const thisHour = DATA.filter(function(d){
		return hour == d.hour; // Deliberate == to match 3 and 03
	});
	cameraArray.forEach( (camera) => {
		// Count number of animal observations on that camera
		const animalCount = thisHour.reduce(function (a, d) {
			if(d.camera == camera){
				return a + +d.count;
			}else{
				return a;
			}
		},0);
		let obj = {};
		obj['hour'] = hour;
		obj['camera'] = camera;
		obj['observations'] = animalCount;
		obsPerHourStackedCameraObject.push( obj );
	});
}



// Observations by hour, grouped by month (12 graphs coming...)
for( let theMonth = 1; theMonth<= 12; theMonth++ ){
	let mhObs = [];
	for( let theHour = 0; theHour <= 23; theHour++){
		const thisHour = DATA.filter(function(d){
			return theHour == d.hour && theMonth == d.month;
		});

		const totalObsCount = thisHour.reduce(function(a, d){
			return a = a + +d.count;
		}, 0);
		const obsObject = {
			hour: theHour,
			observations: totalObsCount
		};
		mhObs.push(obsObject);
	}
	monthlyHourObsObject.push( mhObs );
}

// Animals per day, from start to today
let dayIndex = new Date(oldestDate);
//console.log("animal: dayIndex = " , dayIndex);
//console.log("animal: newestDate = ", newestDate);
//console.log("animal: oldestDate = ", oldestDate);
while( dayIndex <= newestDate ){
	// console.log("Processing date: " + dayIndex);
	// Grab observations for this day
	const thisDayObj = DATA.filter(function(d){
		return d.year == dayIndex.getFullYear() &&
			d.month == (dayIndex.getMonth()+1) && 
			d.day == (dayIndex.getDate()+1);
	});
	const totalObsCount = thisDayObj.reduce(function(a, d){
		return a = a + +d.count;
	},0);
	
	const obs = { };

	const y = dayIndex.getFullYear();
	const m = (dayIndex.getMonth()+1).toString().padStart(2,'0');
	const d = dayIndex.getDate().toString().padStart(2,'0');

	obs["day"] = y + "-" + m + "-" + d;
	obs["observations"] = totalObsCount; 
	dayByDayObsObject.push( obs );

	// next day, next loop
	dayIndex.setDate( dayIndex.getDate() +1 );
}

////// Deer obs by day
// preprocess deer obs: 
const deerConfidenceThreshold = 0.85;
const imagesWithDeer = DEER_OBS_DATA.filter(function(d){
	return d.classification === '1.Deer' &&
		d.confidence >= deerConfidenceThreshold;
});
const imagesWithDeerMap = new Map();
imagesWithDeer.forEach((image) => {
	imagesWithDeerMap.set( image['image'], image['confidence'] );
});
// console.log("found ", imagesWithDeer.length, " images with deer in them");

dayIndex = new Date(oldestDate);
/*
console.log("deer: dayIndex = " , dayIndex);
console.log("deer: newestDate = ", newestDate);
console.log("deer: oldestDate = ", oldestDate);
*/
while( dayIndex <= newestDate ){
	// console.log("Processing date: " + dayIndex);
	// Grab observations for this day
	const thisDayObj = DATA.filter(function(d){
		return d.year == dayIndex.getFullYear() &&
			d.month == (dayIndex.getMonth()+1) && 
			d.day == (dayIndex.getDate()+1) &&
			imagesWithDeerMap.has(d.image);
	});

	const obs = { };
	const y = dayIndex.getFullYear();
	const m = (dayIndex.getMonth()+1).toString().padStart(2,'0');
	const d = dayIndex.getDate().toString().padStart(2,'0');

	obs["day"] = y + "-" + m + "-" + d;
	obs["observations"] = thisDayObj.length;
	// console.log("day" , obs["day"] , " has ", thisDayObj.length, " deer");
	dayByDayDeerObsObject.push( obs );

	//// next day, next loop
	dayIndex.setDate( dayIndex.getDate() +1 );
}


// Animal obs per camera - pending building

// Top Camera, obs per hour
// Observations by hour - Top Camera (irrespective of month, year)
for( let i = 0; i<= 23; i++){
	const thisHour = DATA.filter(function(d){
		return i == d.hour &&  
			d.camera==="TOP"; // delibreate match of 4 == 04 etc
	});
	const totalObsCount = thisHour.reduce(function(a, d){
		return a = a + +d.count;
	}, 0);
	const obsObject = {
		hour: i,
		observations: totalObsCount
	};
	obsPerHourTopCameraObject.push( obsObject );
}
// Observations by hour - Middle Camera (irrespective of month, year)
for( let i = 0; i<= 23; i++){
	const thisHour = DATA.filter(function(d){
		return i == d.hour &&  
			d.camera==="MIDDLE"; // delibreate match of 4 == 04 etc
	});
	const totalObsCount = thisHour.reduce(function(a, d){
		return a = a + +d.count;
	}, 0);
	const obsObject = {
		hour: i,
		observations: totalObsCount
	};
	obsPerHourMiddleCameraObject.push( obsObject );
}
// Observations by hour - House Camera (irrespective of month, year)
for( let i = 0; i<= 23; i++){
	const thisHour = DATA.filter(function(d){
		return i == d.hour &&  
			d.camera==="HOUSE"; // delibreate match of 4 == 04 etc
	});
	const totalObsCount = thisHour.reduce(function(a, d){
		return a = a + +d.count;
	}, 0);
	const obsObject = {
		hour: i,
		observations: totalObsCount
	};


	obsPerHourHouseCameraObject.push( obsObject );
}

//// Deer obs per hour, per camera

// Top Camera, deer obs per hour
// Deer Observations by hour - Top Camera (irrespective of month, year)
let allDeerImages = DATA.filter(function(d){
	return d.count > 0 &&
	imagesWithDeerMap.has(d.image);
});

let subset = allDeerImages.filter(function(d){
	return d.camera==="TOP";
});
for(let i = 0; i<= 23; i++){
	const obsCount = subset.reduce(function(a, d){
		return a = a + +(i == d.hour);
	}, 0);
	const obsObject = {
		hour: i,
		observations: obsCount
	};
	deerObsPerHourTopCameraObject.push( obsObject );
}

// Deer Observations by hour - Middle Camera (irrespective of month, year)
subset = allDeerImages.filter(function(d){
	return d.camera==="MIDDLE";
});
for(let i = 0; i<= 23; i++){
	const obsCount = subset.reduce(function(a, d){
		return a = a + +(i == d.hour);
	}, 0);
	const obsObject = {
		hour: i,
		observations: obsCount
	};
	deerObsPerHourMiddleCameraObject.push( obsObject );
}


// Deer Observations by hour - House Camera (irrespective of month, year)
subset = allDeerImages.filter(function(d){
	return d.camera==="HOUSE"
});
for(let i = 0; i<= 23; i++){
	const thisHour = subset.filter(function(d){
		return i == d.hour;   // delibreate match of 4 == 04 etc
	});
	const obsObject = {
		hour: i,
		observations: thisHour.length
	};
	deerObsPerHourHouseCameraObject.push(obsObject);
}


// #### Start rendering data into graphs ####

// Generate yearly observations
createHBarGraph("#obsPerYear", "Yearly animal observations across all cameras", yearObsObject, "year", "observations");
createHBarGraph("#obsPerMonth", "Total animal observations across all cameras, per month", monthObsObject, "month", "observations");
createHBarGraph("#obsPerHour", "Total animal observations across all cameras, per hour", hourObsObject, "hour", "observations");

createStackedHBarGraph("#obsPerYearStackedCamera", "Yearly observations - by camera", obsPerYearStackedCameraObject, "year", "camera", "observations");
createStackedHBarGraph("#obsPerMonthStackedCamera", "Monthly observations - by camera", obsPerMonthStackedCameraObject, "month", "camera", "observations");
createStackedHBarGraph("#obsPerHourStackedCamera", "Hourly observations - by camera", obsPerHourStackedCameraObject, "hour", "camera", "observations");

for(let i=0; i<12; i++){
	// console.log(monthArray[i]);
	const myDiv = "#obsPerHour" + monthArray[i];
	createHBarGraph(myDiv, "Anmals observed per hour, in " + monthArray[i], monthlyHourObsObject[i], "hour", "observations");
}


createHBarGraph("#dayByDayObs", "Total animal observations per day", dayByDayObsObject, "day", "observations", 3, 1);
let title = "Total deer observations per day (with " + (100*deerConfidenceThreshold) + "% confidence)";
createHBarGraph("#dayByDayDeerObs", title, dayByDayDeerObsObject, "day", "observations", 3, 1);


createHBarGraph("#obsPerHourTopCamera", "Total animals on Top camera, by hour", obsPerHourTopCameraObject, "hour", "observations");
createHBarGraph("#obsPerHourMiddleCamera", "Total animals on Middle camera, by hour", obsPerHourMiddleCameraObject, "hour", "observations");
createHBarGraph("#obsPerHourHouseCamera", "Total animals on House camera, by hour", obsPerHourHouseCameraObject, "hour", "observations");

createHBarGraph("#deerObsPerHourTopCamera", "Total deer on Top camera, by hour", deerObsPerHourTopCameraObject, "hour", "observations");
createHBarGraph("#deerObsPerHourMiddleCamera", "Total deer on Middle camera, by hour", deerObsPerHourMiddleCameraObject, "hour", "observations");
createHBarGraph("#deerObsPerHourHouseCamera", "Total deer on House camera, by hour", deerObsPerHourHouseCameraObject, "hour", "observations");

</script>
</html>
